(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))t(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function i(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(a){if(a.ep)return;a.ep=!0;const n=i(a);fetch(a.href,n)}})();class M{constructor(){this.isLogging=!1,this.originalConsole={log:console.log,error:console.error,warn:console.warn,info:console.info,debug:console.debug};try{this.diagChannel=new BroadcastChannel("evolution-sim-diag"),this.broadcastLog("Logger initialized","info")}catch(e){console.error("Failed to initialize broadcast channel:",e)}this.log=this._log.bind(this,"log"),this.error=this._log.bind(this,"error"),this.warn=this._log.bind(this,"warn"),this.info=this._log.bind(this,"info"),this.debug=this._log.bind(this,"debug"),this._setupErrorHandlers()}_log(e,...i){if(!this.isLogging){this.isLogging=!0;try{const t=i.map(n=>{if(n instanceof Error)return n.stack||n.message;if(n&&typeof n=="object")try{return JSON.stringify(n,null,2)}catch{return String(n)}return String(n)}).join(" ");(this.originalConsole[e]||this.originalConsole.log)(...i),this.broadcastLog(t,e),this._logToUI(i,e)}catch(t){this.originalConsole.error("Logger error:",t),this.broadcastLog(`Logger error: ${t.message}`,"error")}finally{this.isLogging=!1}}}_logToUI(e,i){try{const t=document.getElementById("log");if(!t)return;const a=e.map(d=>{if(d instanceof Error)return d.stack||d.message;if(d&&typeof d=="object")try{return JSON.stringify(d,null,2)}catch{return String(d)}return String(d)}).join(" "),n=new Date,o=document.createElement("div");o.className=`log-entry log-${i}`;const r=document.createElement("span");r.className="log-time",r.textContent=`${n.toISOString().substr(11,8)} `;const l=document.createElement("span");l.className="log-message",l.textContent=a,o.appendChild(r),o.appendChild(l),t.prepend(o),t.children.length>1e3&&t.removeChild(t.lastChild)}catch(t){this.originalConsole.error("Error in UI logger:",t)}}_setupErrorHandlers(){window.addEventListener("error",e=>{this.error("Uncaught Error:",e.error||e.message),e.preventDefault()}),window.addEventListener("unhandledrejection",e=>{this.error("Unhandled Promise Rejection:",e.reason),e.preventDefault()})}broadcastLog(e,i="info"){if(this.diagChannel)try{const t=typeof e=="object"?JSON.stringify(e,null,2):String(e);this.diagChannel.postMessage({type:"log",data:{message:t,type:i,timestamp:new Date().toISOString()}})}catch(t){this.originalConsole.error("Failed to broadcast log:",t)}}}const s=new M;class v{constructor(){this.STORAGE_KEY="evolution_sim_saves",this.saves=this._loadSaves()}_loadSaves(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e).map(t=>({id:t.id||this._generateId(),name:t.name||"Unnamed Save",timestamp:t.timestamp||Date.now(),gameState:t.gameState||{},metadata:{turnCount:t.metadata?.turnCount||0,creatureCount:t.metadata?.creatureCount||0,createdAt:t.metadata?.createdAt||Date.now(),lastPlayed:t.metadata?.lastPlayed||Date.now(),...t.metadata},version:t.version||"1.0.0"})):[]}catch(e){return s.error("Error loading saves:",e),[]}}_saveSaves(){try{return localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.saves)),!0}catch(e){return s.error("Error saving game:",e),!1}}_generateId(){return"save_"+Math.random().toString(36).substr(2,9)}getSaves(){return[...this.saves].sort((e,i)=>i.timestamp-e.timestamp)}getSave(e){return this.saves.find(i=>i.id===e)||null}createSave(e,i="New Save"){const t={id:this._generateId(),name:i.trim()||"Unnamed Save",timestamp:Date.now(),gameState:{...e},metadata:{turnCount:e.turnCount||0,creatureCount:e.creatures?.length||0,createdAt:Date.now(),lastPlayed:Date.now()},version:"1.0.0"};return this.saves.push(t),this._saveSaves(),t}updateSave(e,i){const t=this.saves.findIndex(n=>n.id===e);if(t===-1)return null;const a={...this.saves[t],...i,timestamp:Date.now(),metadata:{...this.saves[t].metadata,...i.metadata||{},lastPlayed:Date.now()}};return this.saves[t]=a,this._saveSaves(),a}deleteSave(e){const i=this.saves.length;return this.saves=this.saves.filter(t=>t.id!==e),this.saves.length<i?(this._saveSaves(),!0):!1}saveGame(e,i,t=null){return t?this.updateSave(t,{gameState:e,metadata:{turnCount:e.turnCount||0,creatureCount:e.creatures?.length||0}}):this.createSave(e,i)}loadGame(e){const i=this.getSave(e);return i?(this.updateSave(e,{metadata:{lastPlayed:Date.now()}}),{...i.gameState,saveId:i.id,saveName:i.name,metadata:{...i.gameState.metadata||{},...i.metadata}}):null}exportSaves(){return JSON.stringify(this.saves,null,2)}importSaves(e,i=!0){try{const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("Invalid save data format");if(i){const a=new Map(this.saves.map(n=>[n.id,n]));t.forEach(n=>{a.set(n.id,{...a.get(n.id)||{},...n,timestamp:n.timestamp||Date.now()})}),this.saves=Array.from(a.values())}else this.saves=t;return this._saveSaves(),!0}catch(t){return s.error("Error importing saves:",t),!1}}}const g=new v;class S{constructor(e){this.app=e,this.elements={},e&&e.saveManager?this.saveManager=e.saveManager:(console.error("SaveManager not available in UIManager constructor"),this.saveManager={getSaves:()=>(console.warn("Using mock saveManager - no saves available"),[]),saveGame:()=>(console.warn("Using mock saveManager - save failed"),null),loadGame:()=>(console.warn("Using mock saveManager - load failed"),null),deleteSave:()=>(console.warn("Using mock saveManager - delete failed"),!1)})}initialize(){this.initializeElements(),this.setupButtonListeners(),s.log("UI Manager initialized")}initializeElements(){this.elements={gameContainer:document.getElementById("game-container"),mainMenu:document.getElementById("main-menu"),newGameBtn:document.getElementById("new-game-btn"),loadGameBtn:document.getElementById("load-game-btn"),settingsBtn:document.getElementById("settings-btn"),pauseMenu:document.getElementById("pause-menu"),resumeBtn:document.getElementById("resume-btn"),saveGameBtn:document.getElementById("save-game-btn"),saveQuitBtn:document.getElementById("save-quit-btn"),settingsMenuBtn:document.getElementById("settings-menu-btn"),quitToMenuBtn:document.getElementById("quit-to-menu-btn")};const e=document.getElementById("new-game-modal");this.elements.newGameModal=e,Object.assign(this.elements,{saveNameInput:document.getElementById("save-name"),closeNewGameBtn:document.getElementById("close-new-game"),cancelNewGameBtn:document.getElementById("cancel-new-game"),confirmNewGameBtn:document.getElementById("confirm-new-game")})}setupButtonListeners(){const{newGameBtn:e,loadGameBtn:i,settingsBtn:t,resumeBtn:a,saveGameBtn:n,saveQuitBtn:o,settingsMenuBtn:r,quitToMenuBtn:l,newGameModal:m,closeNewGameBtn:d,cancelNewGameBtn:p,confirmNewGameBtn:f,saveNameInput:w}=this.elements;d&&d.addEventListener("click",()=>this.hideNewGameModal()),p&&p.addEventListener("click",()=>this.hideNewGameModal()),f&&f.addEventListener("click",()=>this.app.confirmNewGame()),m&&(m.addEventListener("click",c=>{c.target===m&&this.hideNewGameModal()}),w&&(w.addEventListener("keypress",c=>{c.key==="Enter"&&this.app.confirmNewGame()}),w.addEventListener("keydown",c=>{c.key==="Escape"&&this.hideNewGameModal()}))),e&&e.addEventListener("click",()=>this.app.startNewGame()),i&&i.addEventListener("click",()=>this.app.showSaveManager()),t&&t.addEventListener("click",()=>this.app.showSettings()),a&&a.addEventListener("click",()=>this.app.onResumeClick()),n&&n.addEventListener("click",()=>this.app.onSaveGameClick()),o&&o.addEventListener("click",()=>this.app.onSaveAndQuitClick()),r&&r.addEventListener("click",()=>this.app.showSettings()),l&&l.addEventListener("click",()=>this.app.onQuitToMenuClick()),document.addEventListener("keydown",c=>{c.key==="Escape"&&this.app.isRunning&&(this.app.togglePause(),c.preventDefault())})}showMainMenu(){this.elements.mainMenu&&(this.elements.mainMenu.style.display="flex"),this.elements.pauseMenu&&(this.elements.pauseMenu.style.display="none")}hideMainMenu(){this.elements.mainMenu&&(this.elements.mainMenu.style.display="none")}showPauseMenu(){this.elements.pauseMenu?(this.elements.pauseMenu.classList.remove("hidden"),this.elements.pauseMenu.style.display="flex",this.elements.pauseMenu.style.visibility="visible",this.elements.pauseMenu.style.opacity="1"):(console.error("Pause menu element not found in UIManager"),console.error("Available elements in the DOM with IDs:",Array.from(document.querySelectorAll("[id]")).map(e=>e.id)))}hidePauseMenu(){this.elements.pauseMenu&&(this.elements.pauseMenu.style.display="none",this.elements.pauseMenu.classList.add("hidden"))}showConfirmationModal(e,i){const t=document.getElementById("confirmation-modal"),a=document.getElementById("confirmation-message"),n=document.getElementById("confirm-delete"),o=document.getElementById("cancel-delete"),r=document.getElementById("close-confirmation");if(!t||!a||!n||!o||!r){console.error("Confirmation modal elements not found");return}a.textContent=`Are you sure you want to delete "${e.name||"this save"}"?`,t.classList.remove("hidden"),t.style.display="flex",t.style.opacity="1",t.style.visibility="visible";const l=()=>{t.style.opacity="0",t.style.visibility="hidden",setTimeout(()=>{t.style.display="none"},300),n.onclick=null,o.onclick=null,r.onclick=null,t.onclick=null};n.onclick=()=>{typeof i=="function"&&i(),l()};const m=()=>l();o.onclick=m,r.onclick=m,t.onclick=d=>{d.target===t&&l()}}showNewGameModal(){if(this.elements.newGameModal||(this.elements.newGameModal=document.getElementById("new-game-modal")),this.elements.newGameModal){this.elements.newGameModal.classList.remove("hidden"),this.elements.newGameModal.style.display="flex",this.elements.newGameModal.style.visibility="hidden",this.elements.newGameModal.style.opacity="0",this.elements.newGameModal.offsetHeight,this.elements.newGameModal.style.visibility="visible",this.elements.newGameModal.style.opacity="1";const e=i=>{i.key==="Escape"&&this.hideNewGameModal()};document.addEventListener("keydown",e),this.newGameModalKeyHandler=e,this.elements.saveNameInput&&(this.elements.saveNameInput.select(),setTimeout(()=>{this.elements.saveNameInput.focus()},50))}else console.error("New game modal element not found in UIManager"),console.error("Available elements in the DOM with IDs:",Array.from(document.querySelectorAll("[id]")).map(e=>e.id))}hideNewGameModal(){this.elements.newGameModal&&(this.elements.newGameModal.style.display="none",this.newGameModalKeyHandler&&(document.removeEventListener("keydown",this.newGameModalKeyHandler),this.newGameModalKeyHandler=null),this.elements.saveNameInput&&(this.elements.saveNameInput.value=""))}getSaveName(){return this.elements.saveNameInput?this.elements.saveNameInput.value.trim():""}showSaveManager(){const e=document.getElementById("save-manager-modal"),i=document.getElementById("close-save-manager");if(!e||!i){console.error("Save manager modal elements not found");return}e.classList.remove("hidden"),e.style.display="flex",e.style.opacity="1",e.style.visibility="visible",document.body.style.overflow="hidden";const t=a=>{a.key==="Escape"&&this.hideSaveManager()};document.addEventListener("keydown",t),i.onclick=()=>this.hideSaveManager(),e._keyDownHandler=t,this.refreshSaveList()}hideSaveManager(){const e=document.getElementById("save-manager-modal");if(!e)return;e._keyDownHandler&&(document.removeEventListener("keydown",e._keyDownHandler),delete e._keyDownHandler);const i=document.getElementById("close-save-manager");i&&(i.onclick=null),e.style.opacity="0",e.style.visibility="hidden",document.body.style.overflow="",setTimeout(()=>{e.style.display="none"},300)}refreshSaveList(){const e=document.getElementById("saves-list");if(!e){s.error("Saves list element not found");return}e.innerHTML="";try{const i=this.saveManager.getSaves();if(!i||!Array.isArray(i))throw new Error("Invalid saves data received");if(i.length===0){const t=document.createElement("div");t.className="no-saves",t.textContent="No saved games found",e.appendChild(t);return}i.forEach(t=>{try{const a=document.createElement("div");a.className="save-item",a.dataset.saveId=t.id;const o=new Date(t.timestamp).toLocaleString();a.innerHTML=`
                        <div class="save-info">
                            <div class="save-name">${t.name||"Unnamed Save"}</div>
                            <div class="save-meta">
                                <span class="save-date">${o}</span>
                                <span class="save-turn">Turn: ${t.metadata?.turnCount||0}</span>
                                <span class="save-creatures">Creatures: ${t.metadata?.creatureCount||0}</span>
                            </div>
                        </div>
                        <div class="save-actions">
                            <button class="btn btn-load">Load</button>
                            <button class="btn btn-delete">Delete</button>
                        </div>
                    `;const r=a.querySelector(".btn-load");r&&r.addEventListener("click",m=>{m.stopPropagation(),this.app.loadGame(t.id)});const l=a.querySelector(".btn-delete");l&&l.addEventListener("click",m=>{m.stopPropagation(),this.showConfirmationModal(t,()=>{this.saveManager?(this.saveManager.deleteSave(t.id),this.refreshSaveList()):console.error("Save manager not available")})}),e.appendChild(a)}catch(a){console.error("Error creating save item:",a)}})}catch(i){console.error("Error loading saves:",i);const t=document.createElement("div");t.className="error-message",t.textContent="Error loading saved games",e.appendChild(t)}}showNotification(e,i=3e3){let t=document.getElementById("notification");t||(t=document.createElement("div"),t.id="notification",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.zIndex="1000",t.style.transition="opacity 0.3s ease-in-out",t.style.opacity="0",document.body.appendChild(t)),t.textContent=e,t.style.opacity="1",clearTimeout(t._hideTimeout),t._hideTimeout=setTimeout(()=>{t.style.opacity="0"},i)}onResumeClick(){this.app.resumeSimulation()}async onSaveAndQuitClick(){s.log("Save & Quit clicked");try{await this.app.onSaveGameClick(),await new Promise(e=>setTimeout(e,500)),this.onQuitToMenuClick()}catch(e){s.error("Error during save & quit:",e),this.showNotification("Error saving game. Changes may not be saved.")}}async onQuitToMenuClick(){try{s.log("Quitting to main menu..."),await this.app.resetSimulation(),this.showMainMenu(),this.elements.gameContainer&&this.elements.gameContainer.classList.add("hidden"),this.app.isRunning=!1,this.app.isPaused=!1,s.log("Successfully returned to main menu")}catch(e){throw s.error("Error during quit to menu:",e),e}}togglePause(){this.app.isRunning&&(this.app.isPaused=!this.app.isPaused,this.app.isPaused?(window.Module&&(typeof window.Module._emscripten_pause_main_loop=="function"?window.Module._emscripten_pause_main_loop():window.Module.asm&&window.Module.asm._emscripten_pause_main_loop&&window.Module.asm._emscripten_pause_main_loop()),this.showPauseMenu(),s.log("Simulation paused")):this.resumeSimulation())}resumeSimulation(){window.Module&&(typeof window.Module._emscripten_resume_main_loop=="function"?window.Module._emscripten_resume_main_loop():window.Module.asm&&window.Module.asm._emscripten_resume_main_loop&&window.Module.asm._emscripten_resume_main_loop()),this.hidePauseMenu(),this.app.isPaused=!1,s.log("Simulation resumed")}}class b{constructor(){this.selectedCell=null,this.tooltip=this.createTooltip(),this.cellSize=20,this.canvas=null}init(e,i){this.canvas=e,this.cellSize=i,e.addEventListener("mousemove",this.handleMouseMove.bind(this)),e.addEventListener("click",this.handleClick.bind(this)),e.addEventListener("contextmenu",t=>{t.shiftKey&&(t.preventDefault(),this.handleClick(t))}),e.addEventListener("mouseleave",()=>{this.tooltip.style.visibility="hidden"}),document.body.appendChild(this.tooltip)}createTooltip(){const e=document.createElement("div");return e.className="temperature-tooltip",e.style.position="absolute",e.style.pointerEvents="none",e.style.padding="4px 8px",e.style.background="rgba(0, 0, 0, 0.7)",e.style.color="white",e.style.borderRadius="4px",e.style.fontSize="12px",e.style.fontFamily="Arial, sans-serif",e.style.visibility="hidden",e.style.zIndex="1000",e.style.transition="opacity 0.2s",e}handleMouseMove(e){if(!this.canvas)return;const i=this.canvas.getBoundingClientRect(),t=Math.floor((e.clientX-i.left)/this.cellSize),a=Math.floor((e.clientY-i.top)/this.cellSize);this.tooltip.style.left=`${e.clientX+10}px`,this.tooltip.style.top=`${e.clientY+10}px`,this.hoveredCell={x:t,y:a}}handleClick(e){if(this.hoveredCell){if(e.shiftKey){if(e.preventDefault(),this.onTemperatureAdjust){const i=e.button===2;this.onTemperatureAdjust(this.hoveredCell.x,this.hoveredCell.y,i)}return}this.selectedCell={...this.hoveredCell},s.log(`Selected cell: (${this.selectedCell.x}, ${this.selectedCell.y})`)}}updateTooltip(e){if(!this.hoveredCell){this.tooltip.style.visibility="hidden";return}this.tooltip.textContent=`${e.toFixed(1)}°C`,this.tooltip.style.visibility="visible"}getSelectedCell(){return this.selectedCell}getHoveredCell(){return this.hoveredCell}render(e){if(!this.hoveredCell)return;const{x:i,y:t}=this.hoveredCell;e.save(),e.strokeStyle="rgba(255, 255, 255, 0.8)",e.lineWidth=2,e.strokeRect(i*this.cellSize+1,t*this.cellSize+1,this.cellSize-2,this.cellSize-2),this.selectedCell&&this.selectedCell.x===i&&this.selectedCell.y===t&&(e.strokeStyle="rgba(0, 255, 255, 0.8)",e.lineWidth=3,e.strokeRect(i*this.cellSize+1,t*this.cellSize+1,this.cellSize-2,this.cellSize-2)),e.restore()}}const E=new b;class C{constructor(e,i,t=20){this.width=e,this.height=i,this.ambientTemp=t,this.cells=[],this.initialize()}initialize(){const e=this.width/2,i=this.height/2,t=Math.sqrt(e*e+i*i);for(let a=0;a<this.height;a++){const n=[];for(let o=0;o<this.width;o++){const r=o-e,l=a-i,m=Math.sqrt(r*r+l*l)/t,d=this.ambientTemp*(1-m*.5);n.push({temperature:d,nextTemperature:d,lastUpdate:0})}this.cells.push(n)}}update(e){for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++)this.diffuseTemperature(t,i);for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++){const a=this.cells[i][t];a.temperature=a.nextTemperature,a.lastUpdate=performance.now()}return!0}diffuseTemperature(e,i){const t=this.cells[i][e],a=[],n=[[0,1],[1,0],[0,-1],[-1,0]];for(const[o,r]of n){const l=e+o,m=i+r;l>=0&&l<this.width&&m>=0&&m<this.height&&a.push(this.cells[m][l])}if(a.length>0){const l=(a.reduce((m,d)=>m+d.temperature,0)/a.length-t.temperature)*.1;t.nextTemperature=t.temperature+l}else t.nextTemperature=t.temperature}getTemperature(e,i){return e<0||e>=this.width||i<0||i>=this.height?this.ambientTemp:this.cells[i][e].temperature}setTemperature(e,i,t){e>=0&&e<this.width&&i>=0&&i<this.height&&(this.cells[i][e].temperature=t,this.cells[i][e].nextTemperature=t)}getTemperatureData(){const e=[this.width,this.height];for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++)e.push(this.cells[i][t].temperature);return e}}class I{constructor(){this.temperatureSystem=null,this.showTemperature=!1,this.lastUpdate=0,this.updateInterval=100,this.temperatureRanges=[{min:-273.15,max:-100,color:{r:0,g:0,b:139}},{min:-100,max:-50,color:{r:0,g:0,b:255}},{min:-50,max:-20,color:{r:0,g:191,b:255}},{min:-20,max:0,color:{r:173,g:216,b:230}},{min:0,max:20,color:{r:144,g:238,b:144}},{min:20,max:40,color:{r:255,g:255,b:0}},{min:40,max:60,color:{r:255,g:165,b:0}},{min:60,max:80,color:{r:255,g:69,b:0}},{min:80,max:100,color:{r:255,g:0,b:0}},{min:100,max:120,color:{r:178,g:34,b:34}},{min:120,max:1e3,color:{r:128,g:0,b:0}}],this.minTemp=this.temperatureRanges[0].min,this.maxTemp=this.temperatureRanges[this.temperatureRanges.length-1].max}async initialize(e,i,t=20){try{this.temperatureSystem=new C(e,i,t),this.useWasm=!1,this.lastUpdate=performance.now(),s.log("Temperature system (JS) initialized")}catch(a){throw s.error("Failed to initialize temperature system:",a),a}}update(){if(!this.temperatureSystem)return;const e=performance.now(),i=e-this.lastUpdate;return i>=this.updateInterval?(this.temperatureSystem.update(i),this.lastUpdate=e,!0):!1}toggleTemperatureView(){return this.showTemperature=!this.showTemperature,s.log(`Temperature view: ${this.showTemperature?"ON":"OFF"}`),this.showTemperature}getTemperatureColor(e){const i=this.temperatureRanges.find(d=>e>=d.min&&e<d.max)||this.temperatureRanges[this.temperatureRanges.length-1];if(e>=this.temperatureRanges[this.temperatureRanges.length-1].max){const d=this.temperatureRanges[this.temperatureRanges.length-1].color;return`rgb(${d.r}, ${d.g}, ${d.b})`}const t=this.temperatureRanges[this.temperatureRanges.indexOf(i)+1];if(!t){const d=i.color;return`rgb(${d.r}, ${d.g}, ${d.b})`}const a=i.min,n=t.max,o=(e-a)/(n-a),r=Math.round(i.color.r+(t.color.r-i.color.r)*o),l=Math.round(i.color.g+(t.color.g-i.color.g)*o),m=Math.round(i.color.b+(t.color.b-i.color.b)*o);return`rgb(${r}, ${l}, ${m})`}render(e,i,t=!1){if(!(!t||!this.temperatureSystem))try{const a=this.temperatureSystem.getTemperatureData(),n=a[0],o=a[1];e.save(),e.globalAlpha=.7;for(let r=0;r<o;r++)for(let l=0;l<n;l++){const m=a[2+r*n+l];e.fillStyle=this.getTemperatureColor(m),e.fillRect(l*i,r*i,i,i)}e.restore()}catch(a){s.error("Error rendering temperature overlay:",a)}}getTemperature(e,i){return this.temperatureSystem?this.temperatureSystem.getTemperature(e,i):this.minTemp}setTemperature(e,i,t){this.temperatureSystem&&this.temperatureSystem.setTemperature(e,i,t)}}const _=new I;class T{constructor(){this.isInitialized=!1,this.isInitializing=!1,this.wasmInitializationPromise=null,this.currentMainLoop=null,this.isRunning=!1,this.isPaused=!1,this.isAdmin=!1,this.gameState=null,this.showTemperature=!1,this.adminIndicator=null,this.selectionManager=E,this.temperatureManager=_,this.selectionManager.onTemperatureAdjust=(e,i,t=!1)=>{if(this.isAdmin){const o=this.temperatureManager.getTemperature(e,i)+(t?-10:10);this.temperatureManager.setTemperature(e,i,o);const r=t?"Decreased":"Increased";s.log(`${r} temperature at (${e}, ${i}) to ${o.toFixed(1)}°C`)}else s.log("Temperature adjustment requires admin mode")},this.saveManager=g,this.uiManager=new S(this),this.diagChannel=null,this.setupDiagnostics(),this.handleKeyDown=this.handleKeyDown.bind(this),document.addEventListener("keydown",this.handleKeyDown),this.render=this.render.bind(this)}async initialize(){if(this.isInitialized){s.log("Application already initialized");return}if(this.isInitializing)return s.log("Application initialization already in progress"),this.initializationPromise||Promise.resolve();this.isInitializing=!0;try{s.log("Initializing application..."),this.uiManager.initialize(),this.setupDiagnostics(),await this.waitForWasmReady(),window.Module&&typeof window.Module._initialize=="function"?(s.log("Initializing WebAssembly module..."),this.wasmInitializationPromise=this.initializeWasm(),await this.wasmInitializationPromise):s.warn("WebAssembly module not found or missing initialization function"),this.isInitialized=!0,s.log("Application initialized successfully")}catch(e){throw s.error("Error during initialization:",e),e}finally{this.isInitializing=!1}}async render(e){try{this.lastRenderTime||(this.lastRenderTime=e);const i=e-this.lastRenderTime;this.lastRenderTime=e;const t=document.querySelector("canvas");if(!t)return;const a=t.getContext("2d");if(!a)return;if(a.clearRect(0,0,t.width,t.height),this.temperatureManager){if(this.temperatureManager.update(),this.selectionManager){const n=this.selectionManager.getHoveredCell();if(n){const o=this.temperatureManager.getTemperature(n.x,n.y);this.selectionManager.updateTooltip(o)}}this.temperatureManager.render(a,this.grid?.cellSize||20,this.showTemperature)}await this.drawGrid(a,t.width,t.height),this.selectionManager&&this.selectionManager.render(a),this.isRunning&&(this.currentMainLoop=requestAnimationFrame(this.render.bind(this)))}catch(i){throw s.error("Error in render loop:",i),this.isRunning=!1,i}}setupDiagnostics(){try{this.diagChannel=new BroadcastChannel("evolution-sim-diag"),this.diagChannel.onmessage=e=>{const{type:i,data:t}=e.data;switch(i){case"command":this.handleAdminCommand(t);break;case"status":break}},this.sendDiagMessage("status",{connected:!0,isAdmin:this.isAdmin,commands:["set admin true|false","getStatus"]}),this.diagPingInterval=setInterval(()=>{this.sendDiagMessage("status",{connected:!0,isAdmin:this.isAdmin})},1e4),this.sendDiagMessage("log",{message:"Diagnostics channel initialized",type:"info",isAdmin:this.isAdmin})}catch(e){console.error("Failed to initialize diagnostics channel:",e)}}sendDiagMessage(e,i={}){if(this.diagChannel)try{this.diagChannel.postMessage({type:e,timestamp:new Date().toISOString(),data:{...i,isAdmin:this.isAdmin}})}catch(t){s.error("Error sending diagnostic message:",t)}}handleAdminCommand(e){if(!(!e||!e.type)){if(s.log(`Admin command: ${e.type} ${e.data?.key||""}`),e.type==="set"&&e.data&&e.data.key){const{key:i,value:t}=e.data;switch(i.toLowerCase()){case"admin":const a=String(t).toLowerCase()==="true";this.isAdmin!==a&&(this.toggleAdminMode(),s.log(`Admin mode ${a?"enabled":"disabled"}`));break;default:s.warn(`Unknown setting: ${i}`)}return}switch(e.type){case"getStatus":this.sendDiagMessage("status",{isAdmin:this.isAdmin,isRunning:this.isRunning,isPaused:this.isPaused,showTemperature:this.showTemperature});break;default:s.warn(`Unknown admin command: ${e.type}`)}}}toggleAdminMode(){this.isAdmin=!this.isAdmin,this.updateAdminUI(),s.log(`Admin mode ${this.isAdmin?"enabled":"disabled"}`),this.sendDiagMessage("adminStatus",{isAdmin:this.isAdmin})}updateAdminUI(){this.adminIndicator||(this.adminIndicator=document.createElement("div"),this.adminIndicator.id="admin-indicator",this.adminIndicator.style.position="fixed",this.adminIndicator.style.top="10px",this.adminIndicator.style.right="10px",this.adminIndicator.style.padding="5px 10px",this.adminIndicator.style.borderRadius="4px",this.adminIndicator.style.fontFamily="monospace",this.adminIndicator.style.fontWeight="bold",this.adminIndicator.style.zIndex="1000",document.body.appendChild(this.adminIndicator)),this.isAdmin?(this.adminIndicator.textContent="ADMIN MODE",this.adminIndicator.style.backgroundColor="rgba(255, 0, 0, 0.7)",this.adminIndicator.style.color="white",this.adminIndicator.style.display="block",document.addEventListener("keydown",this.handleAdminKeyDown.bind(this))):(this.adminIndicator.style.display="none",document.removeEventListener("keydown",this.handleAdminKeyDown.bind(this)))}handleAdminKeyDown(e){this.isAdmin&&e.key.toLowerCase()==="t"&&(this.showTemperature=!this.showTemperature,s.log(`Temperature overlay ${this.showTemperature?"enabled":"disabled"}`))}waitForWasmReady(){return new Promise((e,i)=>{if(window.wasmReady){s.log("WebAssembly already initialized"),e();return}s.log("Waiting for WebAssembly to be ready...");const t=setTimeout(()=>{const o=new Error("WebAssembly initialization timed out after 30 seconds");s.error(o.message),window.Module?s.error("WebAssembly Module state:",{status:window.Module.status,error:window.Module.error,ready:window.Module.asm?"Module.asm exists":"Module.asm is undefined"}):s.error("window.Module is not defined"),i(o)},3e4),a=()=>{clearTimeout(t),document.removeEventListener("wasm-ready",a),s.log("WebAssembly ready event received"),e(!0)};document.addEventListener("wasm-ready",a);const n=()=>{window.wasmReady?(clearTimeout(t),document.removeEventListener("wasm-ready",a),s.log("WebAssembly ready (window.wasmReady = true)"),e(!0)):window.Module&&window.Module.asm?(clearTimeout(t),document.removeEventListener("wasm-ready",a),s.log("WebAssembly ready (Module.asm detected)"),e(!0)):requestAnimationFrame(n)};n()})}showNewGameModal(){this.uiManager.showNewGameModal()}hideNewGameModal(){this.uiManager.hideNewGameModal()}showMainMenu(){this.uiManager.showMainMenu()}hideMainMenu(){this.uiManager.hideMainMenu()}showPauseMenu(){this.uiManager.showPauseMenu()}hidePauseMenu(){this.uiManager.hidePauseMenu()}getSaveName(){return this.uiManager.getSaveName()}async confirmNewGame(){let e=this.uiManager.getSaveName();e||(e="My Game"),this.gameState||(this.gameState={}),this.gameState.saveName=e,s.log(`Starting new game with save name: ${e}`),this.hideNewGameModal();try{if(!window.Module){s.error("WebAssembly module not loaded");return}s.log("Initializing game state..."),this.uiManager.hideNewGameModal(),this.uiManager.hideMainMenu(),this.uiManager.hidePauseMenu();const i=this.uiManager.elements.gameContainer;i&&i.classList.remove("hidden"),await this.resetSimulation(e),this.isRunning=!0,this.isPaused=!1,await this.startSimulation(),s.log("New game started successfully")}catch(i){throw s.error("Failed to start new game:",i),i}}async startNewGame(){this.showNewGameModal()}async loadWasm(){s.log("Loading WebAssembly module...");try{if(window.Module&&window.Module.asm)return s.log("WebAssembly module already loaded and initialized"),!0;if(window.Module&&!window.wasmReady)return s.log("WebAssembly module loaded but not yet initialized, waiting..."),await this.waitForWasmReady(),!0;if(!window.Module)if(window.loadWasmScript&&typeof window.loadWasmScript=="function")s.log("Manually triggering WebAssembly script load..."),window.loadWasmScript();else throw new Error("WebAssembly module loader not found");if(await this.waitForWasmReady(),!window.Module||!window.Module.asm)throw new Error("WebAssembly module failed to initialize");s.log("WebAssembly module loaded and initialized successfully");const e=Object.keys(window.Module).filter(i=>typeof window.Module[i]=="function"&&!i.startsWith("_emscripten_"));if(s.log("Available Module functions:",e),window.Module.asm){const i=Object.keys(window.Module.asm).filter(t=>typeof window.Module.asm[t]=="function");s.log("Available Module.asm functions:",i)}return!0}catch(e){throw s.error("Failed to load WebAssembly module:",e),window.Module?s.error("Module state on error:",{status:window.Module.status,error:window.Module.error,ready:window.Module.asm?"Module.asm exists":"Module.asm is undefined"}):s.error("window.Module is not defined"),e}}startNewGame(){s.log("Showing new game modal..."),this.uiManager.showNewGameModal()}showSaveManager(){this.uiManager.showSaveManager()}hideSaveManager(){this.uiManager.hideSaveManager()}refreshSaveList(){this.uiManager.refreshSaveList()}async loadGame(e){s.log(`Loading game with ID: ${e}`);try{const i=g.loadGame(e);if(!i){s.error("Failed to load saved game: Invalid save data"),this.uiManager.showNotification("Failed to load saved game. The save file may be corrupted.");return}this.hideSaveManager(),this.hideMainMenu(),this.uiManager.elements.gameContainer&&this.uiManager.elements.gameContainer.classList.remove("hidden"),await this.resetSimulation(i.saveName||"Loaded Game"),this.gameState={...this.gameState,...i,saveId:i.saveId||i.id,saveName:i.saveName||i.name||"Loaded Game"},s.log("Game state after loading:",{saveId:this.gameState.saveId,saveName:this.gameState.saveName,hasGameState:!!this.gameState}),this.isRunning=!0,this.isPaused=!1,this.uiManager.hidePauseMenu(),await this.startSimulation(),s.log("Game loaded successfully"),this.uiManager.showNotification("Game loaded successfully!")}catch(i){s.error("Error loading game:",i),this.uiManager.showNotification("An error occurred while loading the game. Please check the console for details."),this.uiManager.showMainMenu()}}showSettings(){s.log("Showing settings...")}async startSimulation(){if(!window.Module){const e=new Error("WebAssembly module not loaded");throw s.error(e.message),e}try{const e=Object.keys(window.Module).filter(n=>typeof window.Module[n]=="function"&&!n.startsWith("_emscripten_"));s.log("Available Module functions:",e),await this.initializeSimulationGrid();let i=null;if(window.Module.asm&&(typeof window.Module.asm._initialize=="function"?(i=window.Module.asm._initialize,s.log("Found _initialize in Module.asm")):typeof window.Module.asm._start=="function"?(i=window.Module.asm._start,s.log("Found _start in Module.asm")):typeof window.Module.asm._main=="function"&&(i=window.Module.asm._main,s.log("Found _main in Module.asm"))),i||(typeof window.Module._initialize=="function"?(i=window.Module._initialize,s.log("Found _initialize in Module")):typeof window.Module._start=="function"?(i=window.Module._start,s.log("Found _start in Module")):typeof window.Module._main=="function"&&(i=window.Module._main,s.log("Found _main in Module"))),i){s.log("Initializing simulation..."),i(),this.isRunning=!0;const{startBtn:n,pauseBtn:o}=this.elements;n&&(n.disabled=!0),o&&(o.disabled=!1),s.log("Simulation started successfully","success");return}s.log("No initialization function found, setting up render loop..."),this.isRunning=!0,this.isPaused=!1,this.lastRenderTime=null,this.currentMainLoop=requestAnimationFrame(this.render.bind(this));const{startBtn:t,pauseBtn:a}=this.uiManager.elements||{};t&&(t.disabled=!0),a&&(a.disabled=!1),s.log("Render loop started")}catch(e){throw s.error("Error starting simulation:",e),e}}togglePause(){this.isRunning&&(this.isPaused=!this.isPaused,this.isPaused?(window.Module&&(typeof window.Module._emscripten_pause_main_loop=="function"?window.Module._emscripten_pause_main_loop():window.Module.asm&&window.Module.asm._emscripten_pause_main_loop&&window.Module.asm._emscripten_pause_main_loop()),this.uiManager.showPauseMenu(),s.log("Simulation paused")):this.resumeSimulation())}resumeSimulation(){window.Module&&(typeof window.Module._emscripten_resume_main_loop=="function"?window.Module._emscripten_resume_main_loop():window.Module.asm&&window.Module.asm._emscripten_resume_main_loop&&window.Module.asm._emscripten_resume_main_loop()),this.uiManager.hidePauseMenu(),this.isPaused=!1,s.log("Simulation resumed")}onResumeClick(){this.resumeSimulation()}async onSaveAndQuitClick(){s.log("Save & Quit clicked");try{await this.onSaveGameClick(),await new Promise(e=>setTimeout(e,500)),this.onQuitToMenuClick()}catch(e){s.error("Error during save & quit:",e),this.uiManager.showNotification("Error saving game. Changes may not be saved.")}}onSaveGameClick(){if(s.log("Saving game..."),!this.gameState)return s.error("No active game state to save"),this.uiManager.showNotification("Error: No active game to save"),Promise.reject("No active game state");try{const e={turnCount:this.gameState.turnCount||0,...this.gameState},i=this.gameState.saveId,t=this.gameState.saveName||`Game ${new Date().toLocaleString()}`;if(i){const a=g.saveGame(e,t,i);if(a)return s.log("Game updated successfully:",a),this.uiManager.showNotification("Game saved successfully!"),Promise.resolve(a);throw new Error("Failed to update save")}else{const a=g.saveGame(e,t);if(a)return this.gameState.saveId=a.id,this.gameState.saveName=t,s.log("New game saved:",a),this.uiManager.showNotification("New game saved successfully!"),Promise.resolve(a);throw new Error("Failed to create new save")}}catch(e){return s.error("Error saving game:",e),this.uiManager.showNotification("Error saving game: "+(e.message||"Unknown error")),Promise.reject(e)}}async onQuitToMenuClick(){try{s.log("Quitting to main menu..."),this.currentMainLoop&&(window.cancelAnimationFrame(this.currentMainLoop),this.currentMainLoop=null),this.isRunning=!1,this.isPaused=!1,this.uiManager.showMainMenu(),this.uiManager.elements.gameContainer&&this.uiManager.elements.gameContainer.classList.add("hidden"),this.isRunning=!1,this.isPaused=!1,s.log("Successfully returned to main menu")}catch(e){throw s.error("Error during quit to menu:",e),e}}async initializeSimulationGrid(){s.log("Initializing simulation grid...");try{const e=document.querySelector("canvas");if(!e)throw new Error("Canvas element not found");e.width=window.innerWidth,e.height=window.innerHeight;const i=20,t=Math.ceil(e.width/i),a=Math.ceil(e.height/i);this.grid={cellSize:i,width:t,height:a,cells:[]},await this.temperatureManager.initialize(t,a,20),this.selectionManager.init(e,i);for(let n=0;n<a;n++){const o=[];for(let r=0;r<t;r++){const l=this.temperatureManager.getTemperature(r,n);o.push({x:r,y:n,type:"empty",energy:0,creature:null,temperature:l,lastTempUpdate:0})}this.grid.cells.push(o)}s.log(`Initialized grid: ${t}x${a} (${i}px cells)`)}catch(e){throw s.error("Failed to initialize simulation grid:",e),e}}getTemperatureColor(e){const{minTemp:i,maxTemp:t}=this.temperatureSettings;let a=(e-i)/(t-i);a=Math.max(0,Math.min(1,a));const n=Math.round(a*255),o=Math.round((1-a)*255);return`rgb(${n}, 0, ${o})`}handleKeyDown(e){if(e.key.toLowerCase()==="t"){this.showTemperature=!this.showTemperature,s.log(`Temperature view ${this.showTemperature?"enabled":"disabled"}`);const i=this.selectionManager.getHoveredCell();if(i){const t=this.temperatureManager.getTemperature(i.x,i.y);this.selectionManager.updateTooltip(t)}}}async drawGrid(e,i,t){try{if(!e){const n=document.querySelector("canvas");if(!n||(e=n.getContext("2d"),!e))return!1;i=i||n.width,t=t||n.height,e.clearRect(0,0,i,t)}const a=this.grid?.cellSize||20;e.strokeStyle=this.grid?"#1a1a1a":"#333333",e.lineWidth=this.grid?1:.5;for(let n=0;n<=i;n+=a)e.beginPath(),e.moveTo(n,0),e.lineTo(n,t),e.stroke();for(let n=0;n<=t;n+=a)e.beginPath(),e.moveTo(0,n),e.lineTo(i,n),e.stroke();return!0}catch(a){throw s.error("Error drawing grid:",a),a}}async resetSimulation(e="My Game"){try{return s.log(`Resetting simulation with save name: ${e}`),this.currentMainLoop&&(window.cancelAnimationFrame(this.currentMainLoop),this.currentMainLoop=null),this.gameState={isRunning:!1,isPaused:!1,saveName:e,createdAt:new Date().toISOString(),lastSaved:null},await this.initializeSimulationGrid(),s.log("Simulation reset successfully","info"),!0}catch(i){throw s.error("Failed to reset simulation:",i),i}}}const h=new T;window.addEventListener("error",u=>{console.error("Global error:",u.error||u.message),window.app&&window.app.logger&&window.app.logger.error("Global error:",u.error||u.message)});window.addEventListener("unhandledrejection",u=>{console.error("Unhandled promise rejection:",u.reason),window.app&&window.app.logger&&window.app.logger.error("Unhandled promise rejection:",u.reason)});function y(){try{window.app=h,h.initialize(),window.addEventListener("wasm-ready",()=>{console.log("WASM ready event received"),typeof h.onWasmReady=="function"&&h.onWasmReady()}),window.addEventListener("wasm-error",u=>{console.error("WASM error:",u.detail),h.logger&&h.logger.error("Failed to load WebAssembly:",u.detail);const e=document.getElementById("status");e&&(e.textContent=`Error: ${u.detail||"Failed to load WebAssembly"}`,e.style.color="red",e.className="status error")}),window.wasmReady&&typeof h.onWasmReady=="function"&&(console.log("WebAssembly already loaded, initializing app..."),h.onWasmReady())}catch(u){console.error("Failed to initialize application:",u);const e=document.getElementById("status");e&&(e.textContent=`Error: ${u.message||"Failed to initialize application"}`,e.style.color="red",e.className="status error")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):y();
//# sourceMappingURL=main-BNcK56VF.js.map
