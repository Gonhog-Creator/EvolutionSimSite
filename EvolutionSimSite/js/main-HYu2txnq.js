(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();class v{constructor(){this.isLogging=!1,this.originalConsole={log:console.log,error:console.error,warn:console.warn,info:console.info,debug:console.debug};try{this.diagChannel=new BroadcastChannel("evolution-sim-diag"),this.broadcastLog("Logger initialized","info")}catch(e){console.error("Failed to initialize broadcast channel:",e)}this.log=this._log.bind(this,"log"),this.error=this._log.bind(this,"error"),this.warn=this._log.bind(this,"warn"),this.info=this._log.bind(this,"info"),this.debug=this._log.bind(this,"debug"),this._setupErrorHandlers()}_log(e,...i){if(!this.isLogging){this.isLogging=!0;try{const t=i.map(n=>{if(n instanceof Error)return n.stack||n.message;if(n&&typeof n=="object")try{return JSON.stringify(n,null,2)}catch{return String(n)}return String(n)}).join(" ");(this.originalConsole[e]||this.originalConsole.log)(...i),this.broadcastLog(t,e),this._logToUI(i,e)}catch(t){this.originalConsole.error("Logger error:",t),this.broadcastLog(`Logger error: ${t.message}`,"error")}finally{this.isLogging=!1}}}_logToUI(e,i){try{const t=document.getElementById("log");if(!t)return;const s=e.map(d=>{if(d instanceof Error)return d.stack||d.message;if(d&&typeof d=="object")try{return JSON.stringify(d,null,2)}catch{return String(d)}return String(d)}).join(" "),n=new Date,o=document.createElement("div");o.className=`log-entry log-${i}`;const r=document.createElement("span");r.className="log-time",r.textContent=`${n.toISOString().substr(11,8)} `;const l=document.createElement("span");l.className="log-message",l.textContent=s,o.appendChild(r),o.appendChild(l),t.prepend(o),t.children.length>1e3&&t.removeChild(t.lastChild)}catch(t){this.originalConsole.error("Error in UI logger:",t)}}_setupErrorHandlers(){window.addEventListener("error",e=>{this.error("Uncaught Error:",e.error||e.message),e.preventDefault()}),window.addEventListener("unhandledrejection",e=>{this.error("Unhandled Promise Rejection:",e.reason),e.preventDefault()})}broadcastLog(e,i="info"){if(this.diagChannel)try{const t=typeof e=="object"?JSON.stringify(e,null,2):String(e);this.diagChannel.postMessage({type:"log",data:{message:t,type:i,timestamp:new Date().toISOString()}})}catch(t){this.originalConsole.error("Failed to broadcast log:",t)}}}const a=new v;class M{constructor(){this.STORAGE_KEY="evolution_sim_saves",this.saves=this._loadSaves()}_loadSaves(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e).map(t=>({id:t.id||this._generateId(),name:t.name||"Unnamed Save",timestamp:t.timestamp||Date.now(),gameState:t.gameState||{},metadata:{turnCount:t.metadata?.turnCount||0,creatureCount:t.metadata?.creatureCount||0,createdAt:t.metadata?.createdAt||Date.now(),lastPlayed:t.metadata?.lastPlayed||Date.now(),...t.metadata},version:t.version||"1.0.0"})):[]}catch(e){return a.error("Error loading saves:",e),[]}}_saveSaves(){try{return localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.saves)),!0}catch(e){return a.error("Error saving game:",e),!1}}_generateId(){return"save_"+Math.random().toString(36).substr(2,9)}getSaves(){return[...this.saves].sort((e,i)=>i.timestamp-e.timestamp)}getSave(e){return this.saves.find(i=>i.id===e)||null}createSave(e,i="New Save"){const t={id:this._generateId(),name:i.trim()||"Unnamed Save",timestamp:Date.now(),gameState:{...e},metadata:{turnCount:e.turnCount||0,creatureCount:e.creatures?.length||0,createdAt:Date.now(),lastPlayed:Date.now()},version:"1.0.0"};return this.saves.push(t),this._saveSaves(),t}updateSave(e,i){const t=this.saves.findIndex(n=>n.id===e);if(t===-1)return null;const s={...this.saves[t],...i,timestamp:Date.now(),metadata:{...this.saves[t].metadata,...i.metadata||{},lastPlayed:Date.now()}};return this.saves[t]=s,this._saveSaves(),s}deleteSave(e){const i=this.saves.length;return this.saves=this.saves.filter(t=>t.id!==e),this.saves.length<i?(this._saveSaves(),!0):!1}saveGame(e,i,t=null){return t?this.updateSave(t,{gameState:e,metadata:{turnCount:e.turnCount||0,creatureCount:e.creatures?.length||0}}):this.createSave(e,i)}loadGame(e){const i=this.getSave(e);return i?(this.updateSave(e,{metadata:{lastPlayed:Date.now()}}),{...i.gameState,saveId:i.id,saveName:i.name,metadata:{...i.gameState.metadata||{},...i.metadata}}):null}exportSaves(){return JSON.stringify(this.saves,null,2)}importSaves(e,i=!0){try{const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("Invalid save data format");if(i){const s=new Map(this.saves.map(n=>[n.id,n]));t.forEach(n=>{s.set(n.id,{...s.get(n.id)||{},...n,timestamp:n.timestamp||Date.now()})}),this.saves=Array.from(s.values())}else this.saves=t;return this._saveSaves(),!0}catch(t){return a.error("Error importing saves:",t),!1}}}const g=new M;class b{constructor(e){this.app=e,this.elements={},this.fps=0,this.lastTime=performance.now(),this.frames=0,this.simulationTime=0,this.lastUpdateTime=0,this.debugOverlay=null,e&&e.saveManager?this.saveManager=e.saveManager:(console.error("SaveManager not available in UIManager constructor"),this.saveManager={getSaves:()=>(console.warn("Using mock saveManager - no saves available"),[]),saveGame:()=>(console.warn("Using mock saveManager - save failed"),null),loadGame:()=>(console.warn("Using mock saveManager - load failed"),null),deleteSave:()=>(console.warn("Using mock saveManager - delete failed"),!1)})}initialize(){this.initializeElements(),this.setupButtonListeners(),this.createDebugOverlay(),a.log("UI Manager initialized")}createDebugOverlay(){this.debugOverlay=document.createElement("div"),this.debugOverlay.id="debug-overlay",this.debugOverlay.style.position="fixed",this.debugOverlay.style.top="10px",this.debugOverlay.style.left="10px",this.debugOverlay.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.debugOverlay.style.color="#fff",this.debugOverlay.style.padding="8px 12px",this.debugOverlay.style.borderRadius="4px",this.debugOverlay.style.fontFamily="monospace",this.debugOverlay.style.fontSize="14px",this.debugOverlay.style.zIndex="1000",this.debugOverlay.style.pointerEvents="none",this.debugOverlay.style.userSelect="none",this.debugOverlay.style.lineHeight="1.5",this.debugOverlay.innerHTML=`FPS: 0
Time: 0.0s
Temp: N/A`,document.body.appendChild(this.debugOverlay)}updateDebugOverlay(e,i=null){if(!this.debugOverlay)return;if(this.frames++,e-this.lastTime>=1e3&&(this.fps=Math.round(this.frames*1e3/(e-this.lastTime)),this.frames=0,this.lastTime=e),this.app&&this.app.isRunning&&!this.app.isPaused){const s=(e-this.lastUpdateTime)/1e3;this.simulationTime+=s}this.lastUpdateTime=e;let t="No cell selected";i&&i.temp!==void 0&&(t=`Temp: ${i.temp.toFixed(1)}°C`),this.debugOverlay.innerHTML=`
            FPS: ${this.fps}<br>
            Time: ${this.simulationTime.toFixed(1)}s<br>
            ${t}
        `}initializeElements(){this.elements={gameContainer:document.getElementById("game-container"),mainMenu:document.getElementById("main-menu"),newGameBtn:document.getElementById("new-game-btn"),loadGameBtn:document.getElementById("load-game-btn"),settingsBtn:document.getElementById("settings-btn"),pauseMenu:document.getElementById("pause-menu"),resumeBtn:document.getElementById("resume-btn"),saveGameBtn:document.getElementById("save-game-btn"),saveQuitBtn:document.getElementById("save-quit-btn"),settingsMenuBtn:document.getElementById("settings-menu-btn"),quitToMenuBtn:document.getElementById("quit-to-menu-btn")};const e=document.getElementById("new-game-modal");this.elements.newGameModal=e,Object.assign(this.elements,{saveNameInput:document.getElementById("save-name"),closeNewGameBtn:document.getElementById("close-new-game"),cancelNewGameBtn:document.getElementById("cancel-new-game"),confirmNewGameBtn:document.getElementById("confirm-new-game")})}setupButtonListeners(){const{newGameBtn:e,loadGameBtn:i,settingsBtn:t,resumeBtn:s,saveGameBtn:n,saveQuitBtn:o,settingsMenuBtn:r,quitToMenuBtn:l,newGameModal:u,closeNewGameBtn:d,cancelNewGameBtn:p,confirmNewGameBtn:w,saveNameInput:f}=this.elements;d&&d.addEventListener("click",()=>this.hideNewGameModal()),p&&p.addEventListener("click",()=>this.hideNewGameModal()),w&&w.addEventListener("click",()=>this.app.confirmNewGame()),u&&(u.addEventListener("click",m=>{m.target===u&&this.hideNewGameModal()}),f&&(f.addEventListener("keypress",m=>{m.key==="Enter"&&this.app.confirmNewGame()}),f.addEventListener("keydown",m=>{m.key==="Escape"&&this.hideNewGameModal()}))),e&&e.addEventListener("click",()=>this.app.startNewGame()),i&&i.addEventListener("click",()=>this.app.showSaveManager()),t&&t.addEventListener("click",()=>this.app.showSettings()),s&&s.addEventListener("click",()=>this.app.onResumeClick()),n&&n.addEventListener("click",()=>this.app.onSaveGameClick()),o&&o.addEventListener("click",()=>this.app.onSaveAndQuitClick()),r&&r.addEventListener("click",()=>this.app.showSettings()),l&&l.addEventListener("click",()=>this.app.onQuitToMenuClick()),document.addEventListener("keydown",m=>{m.key==="Escape"&&this.app.isRunning&&(this.app.togglePause(),m.preventDefault())})}showMainMenu(){this.elements.mainMenu&&(this.elements.mainMenu.style.display="flex"),this.elements.pauseMenu&&(this.elements.pauseMenu.style.display="none")}hideMainMenu(){this.elements.mainMenu&&(this.elements.mainMenu.style.display="none")}showPauseMenu(){this.elements.pauseMenu?(this.elements.pauseMenu.classList.remove("hidden"),this.elements.pauseMenu.style.display="flex",this.elements.pauseMenu.style.visibility="visible",this.elements.pauseMenu.style.opacity="1"):(console.error("Pause menu element not found in UIManager"),console.error("Available elements in the DOM with IDs:",Array.from(document.querySelectorAll("[id]")).map(e=>e.id)))}hidePauseMenu(){this.elements.pauseMenu&&(this.elements.pauseMenu.style.display="none",this.elements.pauseMenu.classList.add("hidden"))}showConfirmationModal(e,i){const t=document.getElementById("confirmation-modal"),s=document.getElementById("confirmation-message"),n=document.getElementById("confirm-delete"),o=document.getElementById("cancel-delete"),r=document.getElementById("close-confirmation");if(!t||!s||!n||!o||!r){console.error("Confirmation modal elements not found");return}s.textContent=`Are you sure you want to delete "${e.name||"this save"}"?`,t.classList.remove("hidden"),t.style.display="flex",t.style.opacity="1",t.style.visibility="visible";const l=()=>{t.style.opacity="0",t.style.visibility="hidden",setTimeout(()=>{t.style.display="none"},300),n.onclick=null,o.onclick=null,r.onclick=null,t.onclick=null};n.onclick=()=>{typeof i=="function"&&i(),l()};const u=()=>l();o.onclick=u,r.onclick=u,t.onclick=d=>{d.target===t&&l()}}showNewGameModal(){if(this.elements.newGameModal||(this.elements.newGameModal=document.getElementById("new-game-modal")),this.elements.newGameModal){this.elements.newGameModal.classList.remove("hidden"),this.elements.newGameModal.style.display="flex",this.elements.newGameModal.style.visibility="hidden",this.elements.newGameModal.style.opacity="0",this.elements.newGameModal.offsetHeight,this.elements.newGameModal.style.visibility="visible",this.elements.newGameModal.style.opacity="1";const e=i=>{i.key==="Escape"&&this.hideNewGameModal()};document.addEventListener("keydown",e),this.newGameModalKeyHandler=e,this.elements.saveNameInput&&(this.elements.saveNameInput.select(),setTimeout(()=>{this.elements.saveNameInput.focus()},50))}else console.error("New game modal element not found in UIManager"),console.error("Available elements in the DOM with IDs:",Array.from(document.querySelectorAll("[id]")).map(e=>e.id))}hideNewGameModal(){this.elements.newGameModal&&(this.elements.newGameModal.style.display="none",this.newGameModalKeyHandler&&(document.removeEventListener("keydown",this.newGameModalKeyHandler),this.newGameModalKeyHandler=null),this.elements.saveNameInput&&(this.elements.saveNameInput.value=""))}getSaveName(){return this.elements.saveNameInput?this.elements.saveNameInput.value.trim():""}showSaveManager(){const e=document.getElementById("save-manager-modal"),i=document.getElementById("close-save-manager");if(!e||!i){console.error("Save manager modal elements not found");return}e.classList.remove("hidden"),e.style.display="flex",e.style.opacity="1",e.style.visibility="visible",document.body.style.overflow="hidden";const t=s=>{s.key==="Escape"&&this.hideSaveManager()};document.addEventListener("keydown",t),i.onclick=()=>this.hideSaveManager(),e._keyDownHandler=t,this.refreshSaveList()}hideSaveManager(){const e=document.getElementById("save-manager-modal");if(!e)return;e._keyDownHandler&&(document.removeEventListener("keydown",e._keyDownHandler),delete e._keyDownHandler);const i=document.getElementById("close-save-manager");i&&(i.onclick=null),e.style.opacity="0",e.style.visibility="hidden",document.body.style.overflow="",setTimeout(()=>{e.style.display="none"},300)}refreshSaveList(){const e=document.getElementById("saves-list");if(!e){a.error("Saves list element not found");return}e.innerHTML="";try{const i=this.saveManager.getSaves();if(!i||!Array.isArray(i))throw new Error("Invalid saves data received");if(i.length===0){const t=document.createElement("div");t.className="no-saves",t.textContent="No saved games found",e.appendChild(t);return}i.forEach(t=>{try{const s=document.createElement("div");s.className="save-item",s.dataset.saveId=t.id;const o=new Date(t.timestamp).toLocaleString();s.innerHTML=`
                        <div class="save-info">
                            <div class="save-name">${t.name||"Unnamed Save"}</div>
                            <div class="save-meta">
                                <span class="save-date">${o}</span>
                                <span class="save-turn">Turn: ${t.metadata?.turnCount||0}</span>
                                <span class="save-creatures">Creatures: ${t.metadata?.creatureCount||0}</span>
                            </div>
                        </div>
                        <div class="save-actions">
                            <button class="btn btn-load">Load</button>
                            <button class="btn btn-delete">Delete</button>
                        </div>
                    `;const r=s.querySelector(".btn-load");r&&r.addEventListener("click",u=>{u.stopPropagation(),this.app.loadGame(t.id)});const l=s.querySelector(".btn-delete");l&&l.addEventListener("click",u=>{u.stopPropagation(),this.showConfirmationModal(t,()=>{this.saveManager?(this.saveManager.deleteSave(t.id),this.refreshSaveList()):console.error("Save manager not available")})}),e.appendChild(s)}catch(s){console.error("Error creating save item:",s)}})}catch(i){console.error("Error loading saves:",i);const t=document.createElement("div");t.className="error-message",t.textContent="Error loading saved games",e.appendChild(t)}}showNotification(e,i=3e3){let t=document.getElementById("notification");t||(t=document.createElement("div"),t.id="notification",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.zIndex="1000",t.style.transition="opacity 0.3s ease-in-out",t.style.opacity="0",document.body.appendChild(t)),t.textContent=e,t.style.opacity="1",clearTimeout(t._hideTimeout),t._hideTimeout=setTimeout(()=>{t.style.opacity="0"},i)}onResumeClick(){this.app.resumeSimulation()}async onSaveAndQuitClick(){a.log("Save & Quit clicked");try{await this.app.onSaveGameClick(),await new Promise(e=>setTimeout(e,500)),this.onQuitToMenuClick()}catch(e){a.error("Error during save & quit:",e),this.showNotification("Error saving game. Changes may not be saved.")}}async onQuitToMenuClick(){try{a.log("Quitting to main menu..."),await this.app.resetSimulation(),this.showMainMenu(),this.elements.gameContainer&&this.elements.gameContainer.classList.add("hidden"),this.app.isRunning=!1,this.app.isPaused=!1,a.log("Successfully returned to main menu")}catch(e){throw a.error("Error during quit to menu:",e),e}}togglePause(){this.app.isRunning&&(this.app.isPaused=!this.app.isPaused,this.app.isPaused?(window.Module&&(typeof window.Module._emscripten_pause_main_loop=="function"?window.Module._emscripten_pause_main_loop():window.Module.asm&&window.Module.asm._emscripten_pause_main_loop&&window.Module.asm._emscripten_pause_main_loop()),this.showPauseMenu(),a.log("Simulation paused")):this.resumeSimulation())}resumeSimulation(){window.Module&&(typeof window.Module._emscripten_resume_main_loop=="function"?window.Module._emscripten_resume_main_loop():window.Module.asm&&window.Module.asm._emscripten_resume_main_loop&&window.Module.asm._emscripten_resume_main_loop()),this.hidePauseMenu(),this.app.isPaused=!1,a.log("Simulation resumed")}}class S{constructor(){this.selectedCell=null,this.hoveredCell=null,this.isDragging=!1,this.lastProcessedCell=null,this.tooltip=this.createTooltip(),this.cellSize=20,this.canvas=null,this.brushSize=0,this.isAdmin=!1,this.tempAdjustDirection=1,this.dragButton=null}init(e,i){this.canvas=e,this.cellSize=i,this._eventHandlers||(this._eventHandlers={}),this._currentCanvas&&(this._eventHandlers.mouseMove&&this._currentCanvas.removeEventListener("mousemove",this._eventHandlers.mouseMove),this._eventHandlers.mouseDown&&this._currentCanvas.removeEventListener("mousedown",this._eventHandlers.mouseDown),this._eventHandlers.mouseUp&&this._currentCanvas.removeEventListener("mouseup",this._eventHandlers.mouseUp),this._eventHandlers.contextMenu&&this._currentCanvas.removeEventListener("contextmenu",this._eventHandlers.contextMenu),this._eventHandlers.mouseLeave&&this._currentCanvas.removeEventListener("mouseleave",this._eventHandlers.mouseLeave),this._eventHandlers.documentMouseUp&&document.removeEventListener("mouseup",this._eventHandlers.documentMouseUp,!0)),this._currentCanvas=e,this._eventHandlers.mouseMove=this.handleMouseMove.bind(this),this._eventHandlers.mouseDown=this.handleMouseDown.bind(this),this._eventHandlers.mouseUp=this.handleMouseUp.bind(this),this._eventHandlers.contextMenu=this.handleContextMenu.bind(this),this._eventHandlers.mouseLeave=this.handleMouseLeave.bind(this),this._eventHandlers.documentMouseUp=this.handleDocumentMouseUp.bind(this),e.addEventListener("mousemove",this._eventHandlers.mouseMove),e.addEventListener("mousedown",this._eventHandlers.mouseDown),e.addEventListener("mouseup",this._eventHandlers.mouseUp),e.addEventListener("contextmenu",this._eventHandlers.contextMenu),e.addEventListener("mouseleave",this._eventHandlers.mouseLeave),document.addEventListener("mouseup",this._eventHandlers.documentMouseUp),this.selectedCell=null,this.hoveredCell=null,this.isDragging=!1,this.lastProcessedCell=null,this.dragButton=null,document.body.contains(this.tooltip)||document.body.appendChild(this.tooltip)}createTooltip(){const e=document.createElement("div");return e.className="temperature-tooltip",e.style.position="absolute",e.style.pointerEvents="none",e.style.padding="4px 8px",e.style.background="rgba(0, 0, 0, 0.7)",e.style.color="white",e.style.borderRadius="4px",e.style.fontSize="12px",e.style.fontFamily="Arial, sans-serif",e.style.visibility="hidden",e.style.zIndex="1000",e.style.transition="opacity 0.2s",e}handleMouseMove(e){if(!this.canvas)return;const i=(e.buttons&2)===2;this._pendingRightClick&&(i?(clearTimeout(this._pendingRightClick),this._pendingRightClick=null):(clearTimeout(this._pendingRightClick),this._pendingRightClick=null,this.isDragging&&this.dragButton===2&&this.cleanupDragState()));const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top,o=Math.floor(s/this.cellSize),r=Math.floor(n/this.cellSize);(!this.hoveredCell||this.hoveredCell.x!==o||this.hoveredCell.y!==r)&&(this.hoveredCell={x:o,y:r},this.tooltip&&this.tooltip.isVisible&&this.updateTooltipPosition(e),this.isDragging&&this.onTemperatureAdjust&&this.isAdmin&&this.getBrushCells(this.hoveredCell.x,this.hoveredCell.y).forEach(u=>{this.onTemperatureAdjust(u.x,u.y,this.tempAdjustDirection===-1)}))}handleClick(e){this.hoveredCell&&this.onCellSelected&&this.onCellSelected(this.hoveredCell.x,this.hoveredCell.y)}getBrushCells(e,i){if(this.brushSize===0||!this.isAdmin)return[{x:e,y:i}];const t=[],s=this.brushSize,n=s*s;for(let o=-s;o<=s;o++)for(let r=-s;r<=s;r++)r*r+o*o<=n&&t.push({x:e+r,y:i+o});return t}toggleBrushSize(){this.brushSize=this.brushSize===0?2:0}handleDocumentMouseUp(e){const i=e.button===2,t=this.isDragging&&this.dragButton===2;return t||this.isDragging&&(this.dragButton===null||e.button===this.dragButton)?(this.cleanupDragState(),i||t?(e.stopImmediatePropagation(),e.preventDefault(),!0):(e.stopPropagation(),e.preventDefault(),!0)):(i&&this._pendingRightClick&&(clearTimeout(this._pendingRightClick),this._pendingRightClick=null),!1)}handleContextMenu(e){return e.preventDefault(),this.isDragging&&this.dragButton===2?(this.resetDragState(),!0):this.isAdmin?(this.handleMouseDown(e),!0):!1}handleMouseLeave(){this.tooltip.style.visibility="hidden",this.isDragging&&this.resetDragState()}cleanupDragState(){this.isDragging=!1,this.dragButton=null,this.lastProcessedCell=null,this.tempAdjustDirection=0,this._pendingRightClick&&(clearTimeout(this._pendingRightClick),this._pendingRightClick=null)}resetDragState(){this.isDragging&&this.cleanupDragState()}handleMouseUp(e){const i=e.button===2,t=this.isDragging&&this.dragButton===2;if(!((!this.isDragging||this.dragButton!==null&&e.button!==this.dragButton)&&!i)){if(i||t){e.stopImmediatePropagation(),e.preventDefault(),this.cleanupDragState();return}this.cleanupDragState(),e.stopPropagation(),e.preventDefault(),this._pendingRightClick&&(clearTimeout(this._pendingRightClick),this._pendingRightClick=null)}}handleMouseDown(e){if(!this.hoveredCell)return;const i=e.button===2;if(i?(e.stopImmediatePropagation(),e.preventDefault()):(e.stopPropagation(),e.preventDefault()),this.cleanupDragState(),i){this._pendingRightClick&&(clearTimeout(this._pendingRightClick),this._pendingRightClick=null),this.isDragging=!0,this.tempAdjustDirection=-1,this.lastProcessedCell=this.hoveredCell?{...this.hoveredCell}:null,this._pendingRightClick=setTimeout(()=>{if(this.isDragging){this.cleanupDragState();try{const t=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,button:2,buttons:0});document.dispatchEvent(t)}catch{}}this._pendingRightClick=null},3e3);return}if(e.shiftKey&&e.button===0){this.isDragging=!0,this.tempAdjustDirection=1,this.lastProcessedCell={...this.hoveredCell},this.dragButton=0,this.onTemperatureAdjust&&this.getBrushCells(this.hoveredCell.x,this.hoveredCell.y).forEach(s=>{this.onTemperatureAdjust(s.x,s.y,!1)});return}e.button===0&&this.handleSelection()}handleSelection(){if(!this.hoveredCell)return;this.selectedCell&&this.selectedCell.x===this.hoveredCell.x&&this.selectedCell.y===this.hoveredCell.y?this.selectedCell=null:this.selectedCell={...this.hoveredCell}}updateTooltip(e){if(!this.hoveredCell){this.tooltip.style.visibility="hidden";return}this.tooltip.textContent=`${e.toFixed(1)}°C`,this.tooltip.style.visibility="visible"}getSelectedCell(){return this.selectedCell}getHoveredCell(){return this.hoveredCell}render(e){if(e.save(),this.hoveredCell){const i=this.isAdmin&&this.brushSize>0?this.getBrushCells(this.hoveredCell.x,this.hoveredCell.y):[this.hoveredCell];e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=1,e.fillStyle="rgba(255, 255, 255, 0.1)",i.forEach(t=>{const{x:s,y:n}=t;e.strokeRect(s*this.cellSize+1,n*this.cellSize+1,this.cellSize-2,this.cellSize-2),e.fillRect(s*this.cellSize+1,n*this.cellSize+1,this.cellSize-2,this.cellSize-2)})}if(this.selectedCell){const{x:i,y:t}=this.selectedCell;e.strokeStyle="rgba(0, 255, 255, 0.8)",e.lineWidth=3,e.strokeRect(i*this.cellSize+1,t*this.cellSize+1,this.cellSize-2,this.cellSize-2)}e.restore()}}const C=new S;class _{constructor(e,i,t=20){this.width=e,this.height=i,this.ambientTemp=t,this.cells=[],this.initialize()}initialize(){const e=this.width/2,i=this.height/2,t=Math.sqrt(e*e+i*i);for(let s=0;s<this.height;s++){const n=[];for(let o=0;o<this.width;o++){const r=o-e,l=s-i,u=Math.sqrt(r*r+l*l)/t,d=this.ambientTemp*(1-u*.5);n.push({temperature:d,nextTemperature:d,lastUpdate:0})}this.cells.push(n)}}update(e){for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++)this.diffuseTemperature(t,i);for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++){const s=this.cells[i][t];s.temperature=s.nextTemperature,s.lastUpdate=performance.now()}return!0}diffuseTemperature(e,i){const t=this.cells[i][e],s=[],n=[[0,1],[1,0],[0,-1],[-1,0]];for(const[o,r]of n){const l=e+o,u=i+r;l>=0&&l<this.width&&u>=0&&u<this.height&&s.push(this.cells[u][l])}if(s.length>0){const l=(s.reduce((u,d)=>u+d.temperature,0)/s.length-t.temperature)*.1;t.nextTemperature=t.temperature+l}else t.nextTemperature=t.temperature}getTemperature(e,i){return e<0||e>=this.width||i<0||i>=this.height?this.ambientTemp:this.cells[i][e].temperature}setTemperature(e,i,t){e>=0&&e<this.width&&i>=0&&i<this.height&&(this.cells[i][e].temperature=t,this.cells[i][e].nextTemperature=t)}getTemperatureData(){const e=[this.width,this.height];for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++)e.push(this.cells[i][t].temperature);return e}}class E{constructor(){this.temperatureSystem=null,this.showTemperature=!1,this.lastUpdate=0,this.updateInterval=100,this.temperatureRanges=[{min:-273.15,max:-100,color:{r:0,g:0,b:139}},{min:-100,max:-50,color:{r:0,g:0,b:255}},{min:-50,max:-20,color:{r:0,g:191,b:255}},{min:-20,max:0,color:{r:173,g:216,b:230}},{min:0,max:20,color:{r:144,g:238,b:144}},{min:20,max:40,color:{r:255,g:255,b:0}},{min:40,max:60,color:{r:255,g:165,b:0}},{min:60,max:80,color:{r:255,g:69,b:0}},{min:80,max:100,color:{r:255,g:0,b:0}},{min:100,max:120,color:{r:178,g:34,b:34}},{min:120,max:1e3,color:{r:128,g:0,b:0}}],this.minTemp=this.temperatureRanges[0].min,this.maxTemp=this.temperatureRanges[this.temperatureRanges.length-1].max}async initialize(e,i,t=20){try{this.temperatureSystem=new _(e,i,t),this.useWasm=!1,this.lastUpdate=performance.now(),a.log("Temperature system (JS) initialized")}catch(s){throw a.error("Failed to initialize temperature system:",s),s}}update(){if(!this.temperatureSystem)return;const e=performance.now(),i=e-this.lastUpdate;return i>=this.updateInterval?(this.temperatureSystem.update(i),this.lastUpdate=e,!0):!1}toggleTemperatureView(){return this.showTemperature=!this.showTemperature,a.log(`Temperature view: ${this.showTemperature?"ON":"OFF"}`),this.showTemperature}getTemperatureColor(e){const i=this.temperatureRanges.find(d=>e>=d.min&&e<d.max)||this.temperatureRanges[this.temperatureRanges.length-1];if(e>=this.temperatureRanges[this.temperatureRanges.length-1].max){const d=this.temperatureRanges[this.temperatureRanges.length-1].color;return`rgb(${d.r}, ${d.g}, ${d.b})`}const t=this.temperatureRanges[this.temperatureRanges.indexOf(i)+1];if(!t){const d=i.color;return`rgb(${d.r}, ${d.g}, ${d.b})`}const s=i.min,n=t.max,o=(e-s)/(n-s),r=Math.round(i.color.r+(t.color.r-i.color.r)*o),l=Math.round(i.color.g+(t.color.g-i.color.g)*o),u=Math.round(i.color.b+(t.color.b-i.color.b)*o);return`rgb(${r}, ${l}, ${u})`}render(e,i,t=!1){if(!(!t||!this.temperatureSystem))try{const s=this.temperatureSystem.getTemperatureData(),n=s[0],o=s[1];e.save(),e.globalAlpha=.7;for(let r=0;r<o;r++)for(let l=0;l<n;l++){const u=s[2+r*n+l];e.fillStyle=this.getTemperatureColor(u),e.fillRect(l*i,r*i,i,i)}e.restore()}catch(s){a.error("Error rendering temperature overlay:",s)}}getTemperature(e,i){return this.temperatureSystem?this.temperatureSystem.getTemperature(e,i):this.minTemp}setTemperature(e,i,t){this.temperatureSystem&&this.temperatureSystem.setTemperature(e,i,t)}}const T=new E;class B{constructor(){this.isInitialized=!1,this.isInitializing=!1,this.wasmInitializationPromise=null,this.currentMainLoop=null,this.isRunning=!1,this.isPaused=!1,this.isAdmin=!1,this.gameState=null,this.showTemperature=!1,this.adminIndicator=null,this.selectionManager=C,this.temperatureManager=T,this.selectionManager.onTemperatureAdjust=(e,i,t=!1)=>{if(this.isAdmin){const o=this.temperatureManager.getTemperature(e,i)+(t?-10:10);this.temperatureManager.setTemperature(e,i,o)}},this.saveManager=g,this.uiManager=new b(this),this.diagChannel=null,this.setupDiagnostics(),this.handleKeyDown=this.handleKeyDown.bind(this),document.addEventListener("keydown",this.handleKeyDown),this.render=this.render.bind(this)}async initialize(){if(this.isInitialized){a.log("Application already initialized");return}if(this.isInitializing)return a.log("Application initialization already in progress"),this.initializationPromise||Promise.resolve();this.isInitializing=!0;try{a.log("Initializing application..."),this.uiManager.initialize(),this.setupDiagnostics(),await this.waitForWasmReady(),window.Module&&typeof window.Module._initialize=="function"?(a.log("Initializing WebAssembly module..."),this.wasmInitializationPromise=this.initializeWasm(),await this.wasmInitializationPromise):a.warn("WebAssembly module not found or missing initialization function"),this.isInitialized=!0,a.log("Application initialized successfully")}catch(e){throw a.error("Error during initialization:",e),e}finally{this.isInitializing=!1}}async render(e){try{this.lastRenderTime||(this.lastRenderTime=e);const i=e-this.lastRenderTime;this.lastRenderTime=e;const t=document.querySelector("canvas");if(!t)return;const s=t.getContext("2d");if(!s)return;if(s.clearRect(0,0,t.width,t.height),this.temperatureManager){if(this.temperatureManager.update(),this.selectionManager){const n=this.selectionManager.getHoveredCell();if(n){const o=this.temperatureManager.getTemperature(n.x,n.y);this.selectionManager.updateTooltip(o)}}this.temperatureManager.render(s,this.grid?.cellSize||20,this.showTemperature)}if(await this.drawGrid(s,t.width,t.height),this.selectionManager){this.selectionManager.render(s);let n=null;const o=this.selectionManager.getSelectedCell();o&&this.temperatureManager&&(n={temp:this.temperatureManager.getTemperature(o.x,o.y),x:o.x,y:o.y}),this.uiManager&&this.uiManager.updateDebugOverlay&&this.uiManager.updateDebugOverlay(e,n)}this.isRunning&&(this.currentMainLoop=requestAnimationFrame(this.render.bind(this)))}catch(i){throw a.error("Error in render loop:",i),this.isRunning=!1,i}}setupDiagnostics(){try{this.diagChannel=new BroadcastChannel("evolution-sim-diag"),this.diagChannel.onmessage=e=>{const{type:i,data:t}=e.data;switch(i){case"command":this.handleAdminCommand(t);break;case"status":break}},this.sendDiagMessage("status",{connected:!0,isAdmin:this.isAdmin,commands:["set admin true|false","getStatus"]}),this.diagPingInterval=setInterval(()=>{this.sendDiagMessage("status",{connected:!0,isAdmin:this.isAdmin})},1e4),this.sendDiagMessage("log",{message:"Diagnostics channel initialized",type:"info",isAdmin:this.isAdmin})}catch(e){console.error("Failed to initialize diagnostics channel:",e)}}sendDiagMessage(e,i={}){if(this.diagChannel)try{this.diagChannel.postMessage({type:e,timestamp:new Date().toISOString(),data:{...i,isAdmin:this.isAdmin}})}catch(t){a.error("Error sending diagnostic message:",t)}}handleAdminCommand(e){if(!(!e||!e.type)){if(a.log(`Admin command: ${e.type} ${e.data?.key||""}`),e.type==="set"&&e.data&&e.data.key){const{key:i,value:t}=e.data;switch(i.toLowerCase()){case"admin":const s=String(t).toLowerCase()==="true";this.isAdmin!==s&&(this.toggleAdminMode(),a.log(`Admin mode ${s?"enabled":"disabled"}`));break;default:a.warn(`Unknown setting: ${i}`)}return}switch(e.type){case"getStatus":this.sendDiagMessage("status",{isAdmin:this.isAdmin,isRunning:this.isRunning,isPaused:this.isPaused,showTemperature:this.showTemperature});break;default:a.warn(`Unknown admin command: ${e.type}`)}}}toggleAdminMode(){this.isAdmin=!this.isAdmin,this.updateAdminUI(),a.log(`Admin mode ${this.isAdmin?"enabled":"disabled"}`),this.sendDiagMessage("adminStatus",{isAdmin:this.isAdmin})}updateAdminUI(){this.adminContainer||(this.adminContainer=document.createElement("div"),this.adminContainer.id="admin-container",this.adminContainer.style.position="fixed",this.adminContainer.style.top="10px",this.adminContainer.style.right="10px",this.adminContainer.style.display="flex",this.adminContainer.style.flexDirection="column",this.adminContainer.style.gap="5px",this.adminContainer.style.zIndex="1000",document.body.appendChild(this.adminContainer),this.adminIndicator=document.createElement("div"),this.adminIndicator.id="admin-indicator",this.adminIndicator.style.padding="5px 10px",this.adminIndicator.style.borderRadius="4px",this.adminIndicator.style.fontFamily="monospace",this.adminIndicator.style.fontWeight="bold",this.adminIndicator.textContent="ADMIN MODE",this.adminContainer.appendChild(this.adminIndicator),this.adminBrushButton=document.createElement("button"),this.adminBrushButton.id="admin-brush-button",this.updateBrushButtonText(),this.adminBrushButton.style.padding="5px 10px",this.adminBrushButton.style.borderRadius="4px",this.adminBrushButton.style.border="1px solid #ccc",this.adminBrushButton.style.cursor="pointer",this.adminBrushButton.addEventListener("click",e=>{e.stopPropagation(),this.selectionManager&&(this.selectionManager.toggleBrushSize(),this.updateBrushButtonText(),a.log(`Brush size toggled to ${this.selectionManager.brushSize===0?"1x1":"5x5 circle"}`))}),this.adminContainer.appendChild(this.adminBrushButton)),this.isAdmin?(this.adminContainer.style.display="flex",this.adminIndicator.style.display="block",this.adminBrushButton.style.display="block",this.selectionManager&&(this.selectionManager.isAdmin=!0),document.addEventListener("keydown",this.handleAdminKeyDown.bind(this))):(this.adminContainer.style.display="none",this.adminIndicator.style.display="none",this.adminBrushButton.style.display="none",document.removeEventListener("keydown",this.handleAdminKeyDown.bind(this)),this.selectionManager&&(this.selectionManager.isAdmin=!1,this.selectionManager.brushSize=0))}handleAdminKeyDown(e){this.isAdmin&&e.key.toLowerCase()==="t"&&(this.showTemperature=!this.showTemperature,a.log(`Temperature overlay ${this.showTemperature?"enabled":"disabled"}`))}waitForWasmReady(){return new Promise((e,i)=>{if(window.wasmReady){a.log("WebAssembly already initialized"),e();return}a.log("Waiting for WebAssembly to be ready...");const t=setTimeout(()=>{const o=new Error("WebAssembly initialization timed out after 30 seconds");a.error(o.message),window.Module?a.error("WebAssembly Module state:",{status:window.Module.status,error:window.Module.error,ready:window.Module.asm?"Module.asm exists":"Module.asm is undefined"}):a.error("window.Module is not defined"),i(o)},3e4),s=()=>{clearTimeout(t),document.removeEventListener("wasm-ready",s),a.log("WebAssembly ready event received"),e(!0)};document.addEventListener("wasm-ready",s);const n=()=>{window.wasmReady?(clearTimeout(t),document.removeEventListener("wasm-ready",s),a.log("WebAssembly ready (window.wasmReady = true)"),e(!0)):window.Module&&window.Module.asm?(clearTimeout(t),document.removeEventListener("wasm-ready",s),a.log("WebAssembly ready (Module.asm detected)"),e(!0)):requestAnimationFrame(n)};n()})}updateBrushButtonText(){this.adminBrushButton&&this.selectionManager&&(this.adminBrushButton.textContent=`Brush: ${this.selectionManager.brushSize===0?"1x1":"5x5"}`,this.adminBrushButton.style.backgroundColor=this.selectionManager.brushSize===0?"#f0f0f0":"#4CAF50",this.adminBrushButton.style.color=this.selectionManager.brushSize===0?"#000":"#fff")}showNewGameModal(){this.uiManager.showNewGameModal()}hideNewGameModal(){this.uiManager.hideNewGameModal()}showMainMenu(){this.uiManager.showMainMenu()}hideMainMenu(){this.uiManager.hideMainMenu()}showPauseMenu(){this.uiManager.showPauseMenu()}hidePauseMenu(){this.uiManager.hidePauseMenu()}getSaveName(){return this.uiManager.getSaveName()}async confirmNewGame(){let e=this.uiManager.getSaveName();e||(e="My Game"),this.gameState||(this.gameState={}),this.gameState.saveName=e,a.log(`Starting new game with save name: ${e}`),this.hideNewGameModal();try{if(!window.Module){a.error("WebAssembly module not loaded");return}a.log("Initializing game state..."),this.uiManager.hideNewGameModal(),this.uiManager.hideMainMenu(),this.uiManager.hidePauseMenu();const i=this.uiManager.elements.gameContainer;i&&i.classList.remove("hidden"),await this.resetSimulation(e),this.isRunning=!0,this.isPaused=!1,await this.startSimulation(),a.log("New game started successfully")}catch(i){throw a.error("Failed to start new game:",i),i}}async startNewGame(){this.showNewGameModal()}async loadWasm(){a.log("Loading WebAssembly module...");try{if(window.Module&&window.Module.asm)return a.log("WebAssembly module already loaded and initialized"),!0;if(window.Module&&!window.wasmReady)return a.log("WebAssembly module loaded but not yet initialized, waiting..."),await this.waitForWasmReady(),!0;if(!window.Module)if(window.loadWasmScript&&typeof window.loadWasmScript=="function")a.log("Manually triggering WebAssembly script load..."),window.loadWasmScript();else throw new Error("WebAssembly module loader not found");if(await this.waitForWasmReady(),!window.Module||!window.Module.asm)throw new Error("WebAssembly module failed to initialize");a.log("WebAssembly module loaded and initialized successfully");const e=Object.keys(window.Module).filter(i=>typeof window.Module[i]=="function"&&!i.startsWith("_emscripten_"));if(a.log("Available Module functions:",e),window.Module.asm){const i=Object.keys(window.Module.asm).filter(t=>typeof window.Module.asm[t]=="function");a.log("Available Module.asm functions:",i)}return!0}catch(e){throw a.error("Failed to load WebAssembly module:",e),window.Module?a.error("Module state on error:",{status:window.Module.status,error:window.Module.error,ready:window.Module.asm?"Module.asm exists":"Module.asm is undefined"}):a.error("window.Module is not defined"),e}}startNewGame(){a.log("Showing new game modal..."),this.uiManager.showNewGameModal()}showSaveManager(){this.uiManager.showSaveManager()}hideSaveManager(){this.uiManager.hideSaveManager()}refreshSaveList(){this.uiManager.refreshSaveList()}async loadGame(e){a.log(`Loading game with ID: ${e}`);try{const i=g.loadGame(e);if(!i){a.error("Failed to load saved game: Invalid save data"),this.uiManager.showNotification("Failed to load saved game. The save file may be corrupted.");return}this.hideSaveManager(),this.hideMainMenu(),this.uiManager.elements.gameContainer&&this.uiManager.elements.gameContainer.classList.remove("hidden"),await this.resetSimulation(i.saveName||"Loaded Game"),this.gameState={...this.gameState,...i,saveId:i.saveId||i.id,saveName:i.saveName||i.name||"Loaded Game"},a.log("Game state after loading:",{saveId:this.gameState.saveId,saveName:this.gameState.saveName,hasGameState:!!this.gameState}),this.isRunning=!0,this.isPaused=!1,this.uiManager.hidePauseMenu(),await this.startSimulation(),a.log("Game loaded successfully"),this.uiManager.showNotification("Game loaded successfully!")}catch(i){a.error("Error loading game:",i),this.uiManager.showNotification("An error occurred while loading the game. Please check the console for details."),this.uiManager.showMainMenu()}}showSettings(){a.log("Showing settings...")}async startSimulation(){if(!window.Module){const e=new Error("WebAssembly module not loaded");throw a.error(e.message),e}try{const e=Object.keys(window.Module).filter(n=>typeof window.Module[n]=="function"&&!n.startsWith("_emscripten_"));a.log("Available Module functions:",e),await this.initializeSimulationGrid();let i=null;if(window.Module.asm&&(typeof window.Module.asm._initialize=="function"?(i=window.Module.asm._initialize,a.log("Found _initialize in Module.asm")):typeof window.Module.asm._start=="function"?(i=window.Module.asm._start,a.log("Found _start in Module.asm")):typeof window.Module.asm._main=="function"&&(i=window.Module.asm._main,a.log("Found _main in Module.asm"))),i||(typeof window.Module._initialize=="function"?(i=window.Module._initialize,a.log("Found _initialize in Module")):typeof window.Module._start=="function"?(i=window.Module._start,a.log("Found _start in Module")):typeof window.Module._main=="function"&&(i=window.Module._main,a.log("Found _main in Module"))),i){a.log("Initializing simulation..."),i(),this.isRunning=!0;const{startBtn:n,pauseBtn:o}=this.elements;n&&(n.disabled=!0),o&&(o.disabled=!1),a.log("Simulation started successfully","success");return}a.log("No initialization function found, setting up render loop..."),this.isRunning=!0,this.isPaused=!1,this.lastRenderTime=null,this.currentMainLoop=requestAnimationFrame(this.render.bind(this));const{startBtn:t,pauseBtn:s}=this.uiManager.elements||{};t&&(t.disabled=!0),s&&(s.disabled=!1),a.log("Render loop started")}catch(e){throw a.error("Error starting simulation:",e),e}}togglePause(){this.isRunning&&(this.isPaused=!this.isPaused,this.isPaused?(window.Module&&(typeof window.Module._emscripten_pause_main_loop=="function"?window.Module._emscripten_pause_main_loop():window.Module.asm&&window.Module.asm._emscripten_pause_main_loop&&window.Module.asm._emscripten_pause_main_loop()),this.uiManager.showPauseMenu(),a.log("Simulation paused")):this.resumeSimulation())}resumeSimulation(){window.Module&&(typeof window.Module._emscripten_resume_main_loop=="function"?window.Module._emscripten_resume_main_loop():window.Module.asm&&window.Module.asm._emscripten_resume_main_loop&&window.Module.asm._emscripten_resume_main_loop()),this.uiManager.hidePauseMenu(),this.isPaused=!1,a.log("Simulation resumed")}onResumeClick(){this.resumeSimulation()}async onSaveAndQuitClick(){a.log("Save & Quit clicked");try{await this.onSaveGameClick(),await new Promise(e=>setTimeout(e,500)),this.onQuitToMenuClick()}catch(e){a.error("Error during save & quit:",e),this.uiManager.showNotification("Error saving game. Changes may not be saved.")}}onSaveGameClick(){if(a.log("Saving game..."),!this.gameState)return a.error("No active game state to save"),this.uiManager.showNotification("Error: No active game to save"),Promise.reject("No active game state");try{const e={turnCount:this.gameState.turnCount||0,...this.gameState},i=this.gameState.saveId,t=this.gameState.saveName||`Game ${new Date().toLocaleString()}`;if(i){const s=g.saveGame(e,t,i);if(s)return a.log("Game updated successfully:",s),this.uiManager.showNotification("Game saved successfully!"),Promise.resolve(s);throw new Error("Failed to update save")}else{const s=g.saveGame(e,t);if(s)return this.gameState.saveId=s.id,this.gameState.saveName=t,a.log("New game saved:",s),this.uiManager.showNotification("New game saved successfully!"),Promise.resolve(s);throw new Error("Failed to create new save")}}catch(e){return a.error("Error saving game:",e),this.uiManager.showNotification("Error saving game: "+(e.message||"Unknown error")),Promise.reject(e)}}async onQuitToMenuClick(){try{a.log("Quitting to main menu..."),this.currentMainLoop&&(window.cancelAnimationFrame(this.currentMainLoop),this.currentMainLoop=null),this.isRunning=!1,this.isPaused=!1,this.uiManager.showMainMenu(),this.uiManager.elements.gameContainer&&this.uiManager.elements.gameContainer.classList.add("hidden"),this.isRunning=!1,this.isPaused=!1,a.log("Successfully returned to main menu")}catch(e){throw a.error("Error during quit to menu:",e),e}}async initializeSimulationGrid(){a.log("Initializing simulation grid...");try{const e=document.querySelector("canvas");if(!e)throw new Error("Canvas element not found");e.width=window.innerWidth,e.height=window.innerHeight;const i=20,t=Math.ceil(e.width/i),s=Math.ceil(e.height/i);this.grid={cellSize:i,width:t,height:s,cells:[]},await this.temperatureManager.initialize(t,s,20),this.selectionManager.init(e,i);for(let n=0;n<s;n++){const o=[];for(let r=0;r<t;r++){const l=this.temperatureManager.getTemperature(r,n);o.push({x:r,y:n,type:"empty",energy:0,creature:null,temperature:l,lastTempUpdate:0})}this.grid.cells.push(o)}a.log(`Initialized grid: ${t}x${s} (${i}px cells)`)}catch(e){throw a.error("Failed to initialize simulation grid:",e),e}}getTemperatureColor(e){const{minTemp:i,maxTemp:t}=this.temperatureSettings||{minTemp:0,maxTemp:100},s=t-i;let n=s!==0?(e-i)/s:.5;n=Math.max(0,Math.min(1,n));const o=Math.round(n*255),r=Math.round((1-n)*255);return`rgb(${o}, 0, ${r})`}handleKeyDown(e){if(e.key.toLowerCase()==="t"){if(this.showTemperature=!this.showTemperature,this.selectionManager&&typeof this.selectionManager.getHoveredCell=="function"){const i=this.selectionManager.getHoveredCell();if(i&&this.temperatureManager){const t=this.temperatureManager.getTemperature(i.x,i.y);this.selectionManager.updateTooltip&&this.selectionManager.updateTooltip(t)}}return e.preventDefault(),e.stopPropagation(),!1}}async drawGrid(e,i,t){try{if(!e){const n=document.querySelector("canvas");if(!n||(e=n.getContext("2d"),!e))return!1;i=i||n.width,t=t||n.height,e.clearRect(0,0,i,t)}const s=this.grid?.cellSize||20;e.strokeStyle=this.grid?"#1a1a1a":"#333333",e.lineWidth=this.grid?1:.5;for(let n=0;n<=i;n+=s)e.beginPath(),e.moveTo(n,0),e.lineTo(n,t),e.stroke();for(let n=0;n<=t;n+=s)e.beginPath(),e.moveTo(0,n),e.lineTo(i,n),e.stroke();return!0}catch(s){throw a.error("Error drawing grid:",s),s}}async resetSimulation(e="My Game"){try{return a.log(`Resetting simulation with save name: ${e}`),this.currentMainLoop&&(window.cancelAnimationFrame(this.currentMainLoop),this.currentMainLoop=null),this.gameState={isRunning:!1,isPaused:!1,saveName:e,createdAt:new Date().toISOString(),lastSaved:null},await this.initializeSimulationGrid(),a.log("Simulation reset successfully","info"),!0}catch(i){throw a.error("Failed to reset simulation:",i),i}}}const c=new B;window.addEventListener("error",h=>{console.error("Global error:",h.error||h.message),window.app&&window.app.logger&&window.app.logger.error("Global error:",h.error||h.message)});window.addEventListener("unhandledrejection",h=>{console.error("Unhandled promise rejection:",h.reason),window.app&&window.app.logger&&window.app.logger.error("Unhandled promise rejection:",h.reason)});function y(){try{window.app=c,c.initialize(),window.addEventListener("wasm-ready",()=>{console.log("WASM ready event received"),typeof c.onWasmReady=="function"&&c.onWasmReady()}),window.addEventListener("wasm-error",h=>{console.error("WASM error:",h.detail),c.logger&&c.logger.error("Failed to load WebAssembly:",h.detail);const e=document.getElementById("status");e&&(e.textContent=`Error: ${h.detail||"Failed to load WebAssembly"}`,e.style.color="red",e.className="status error")}),window.wasmReady&&typeof c.onWasmReady=="function"&&(console.log("WebAssembly already loaded, initializing app..."),c.onWasmReady())}catch(h){console.error("Failed to initialize application:",h);const e=document.getElementById("status");e&&(e.textContent=`Error: ${h.message||"Failed to initialize application"}`,e.style.color="red",e.className="status error")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):y();
//# sourceMappingURL=main-HYu2txnq.js.map
